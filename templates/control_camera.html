<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sony Camera Control</title>
  <style>
    #liveViewContainer {
      display: none; /* Hidden by default */
      margin-top: 20px;
    }
    #liveViewImage {
      width: 700px; 
      height: 500px; 
      border: 1px solid #ccc;
    }
  </style>
</head>

<body>
  <h1>Camera Control</h1>

  {% if alert %}
    <h1>{{ alert }}</h1>
  {% endif %}

  <!-- Render the form using Django's form tools -->
  <form id="cameraControlForm" method="post" action="{% url 'control_camera' %}">
    {% csrf_token %}
    <input type="hidden" name="uuid" value="{{ current_uuid }}">
    <input type="hidden" id="id_isLiveView" name="isLiveView" value="0">
    <input type="hidden" id="id_isRecord" name="isRecord" value="0">
    <input type="hidden" id="id_isStillShooting" name="isStillShooting" value="0">

    <p>
        {{ form.group.label_tag }} {{ form.group }}
    </p>
    <p>
        {{ form.action.label_tag }} {{ form.action }}
    </p>
    <button type="submit">Submit</button>
  </form>

  <!-- Container for params dropbox -->
  <div id="paramsContainer" style="display: none;">
    <button id="paramsConfirmButton" type="button">Confirm</button>
  </div>

  <div id="paramsInputContainer"></div>

  <div id="liveViewContainer">
    <h2>Live View</h2>
    <img id="liveViewImage" src="" alt="Live View Stream">
  </div>

  <h3 id="localServerResponse" style="display: none;"></h3>

  <script>
    function init() {
      initGroupSelectionListener();
      initFormSubmissionListener();
    }

    // Handle api group selection
    function initGroupSelectionListener() {
      const groupSelect = document.getElementById('id_group');
      const actionSelect = document.getElementById('id_action');
      const paramsContainer = document.getElementById('paramsContainer');
      const paramsInputContainer = document.getElementById('paramsInputContainer');

      groupSelect.addEventListener('change', function() {
        handleGroupChange(groupSelect, actionSelect, paramsContainer, paramsInputContainer);
      });

      actionSelect.addEventListener('change', function() {
        resetParams(paramsContainer, paramsInputContainer);
      });
    }

    // Handle actions upon change api group
    function handleGroupChange(groupSelect, actionSelect, paramsContainer, paramsInputContainer) {
      const groupId = groupSelect.value;

      // Reset fields params options field
      actionSelect.innerHTML = '';
      resetParams(paramsContainer, paramsInputContainer);

      // Fetch the apis of the newly choosen group
      if (groupId) {
        fetchApisForGroup(groupId, actionSelect);
      }
    }

    // Handle the fetching of apis
    function fetchApisForGroup(groupId, actionSelect) {
      fetch("{% url 'api_list' %}?group_id=" + groupId)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            setAlert(data.error)
          } else {
            populateActionSelect(actionSelect, data.apis);
          }
        })
        .catch((error) => {
          setAlert('Error fetching APIs: '+ error);
        });
    }
  
    // Populate api options field with fetched apis
    function populateActionSelect(actionSelect, apis) {
      apis.forEach(function(api) {
        const apiOption = document.createElement('option');
        apiOption.value = api.id;
        apiOption.textContent = api.name;
        actionSelect.appendChild(apiOption);
      });
    }

    function resetParams(paramsContainer, paramsInputContainer) {
      paramsContainer.innerHTML = '';
      paramsInputContainer.innerHTML = '';
    }

    // Api-Form submission logic
    function initFormSubmissionListener() {
      const form = document.getElementById('cameraControlForm');
      form.addEventListener('submit', handleFormSubmission);
    }

    function handleFormSubmission(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const formAction = form.getAttribute('action');
      const localServerResponse = document.getElementById('localServerResponse')

      localServerResponse.style.display = 'none'

      fetch(formAction, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(response => response.json())
      .then(data => {
        
        console.log("Data whole object: "+JSON.stringify(data, null, 2))

        if (data.error) { // If Error field is in the reponse -> error 
          setAlert('❌ Error: ' + JSON.stringify(data.error, null, 2))
        } else if (data.params) {
            let params_selection_types = data.params.type
            
            if (params_selection_types.length == 1){ 
              let params_selection_type = params_selection_types[0] 
              
              if (params_selection_type == 'choose'){ // Case User only needs to choose 1 param from existing ones
                handleChooseParamsResponse(data)
              } else if(params_selection_type == 'input') { // case User only needs to input params 
                handleInputParamsResponse(data)
              } 
            } else { 
              // Setting white balance needs params selection an params input but the input is occational and only 
              // required if a certain param is selected -> query the params to be selected firstly
              console.log("Reached more than 1 param types.")
              
              if (data.payload.action == "setWhiteBalance"){
                setParamSelection(data.params.params.slice(0,1), (selectedParams) => {

                  console.log("selectedParams:", selectedParams);

                  if (selectedParams.includes("Color Temperature")){
                    const input_config = data.params.params.slice(1,2) 
                    setManualParamInput(input_config, (inputValue) => {
                      
                      console.log("Input params: ", inputValue)
                      console.log("Type of input params: ", typeof(inputValue))
                      
                      const allParams = [...selectedParams, true, ...inputValue];

                      console.log("All params: "+ allParams)

                      data.payload.payload["params"] = allParams
                      sendRequestToLocalServer(data.payload.action_list_url, data.payload.payload, data.payload.action);
                    });
                  } else {
                    const allParams = [...selectedParams, true, 3000]
                    data.payload.payload["params"] = allParams
                    sendRequestToLocalServer(data.payload.action_list_url, data.payload.payload, data.payload.action);
                  }
                });
              }
            } handleMixedParamsResponse(data)
        } else {
          sendRequestToLocalServer(data.payload.action_list_url, data.payload.payload, data.payload.action);
        }
      })
      .catch((error) => {
        setAlert('Error: '+error);
      });
    }

    function handleMixedParamsResponse(data){ 

    }

    function handleInputParamsResponse(data){
      input_configs = data.params.params
      setManualParamInput(input_configs, (inputValues) => {
        data.payload.payload["params"] = inputValues
        sendRequestToLocalServer(data.payload.action_list_url, data.payload.payload, data.payload.action);
      });
    }

    function setManualParamInput(input_configs, callback) {
      const paramsInputContainer = document.getElementById('paramsInputContainer');
      paramsInputContainer.innerHTML = '';
      const numberOfInputs = input_configs.length

      for (let i = 0; i < numberOfInputs; i++) {
        const paramInput = document.createElement('input');
        paramInput.type = 'number';
        paramInput.id = `input${i}`;
        paramInput.step = input_configs[i][2];
        paramInput.min = input_configs[i][0];
        paramInput.max = input_configs[i][1];

        paramsInputContainer.appendChild(paramInput);
      }

      const submitButton = document.createElement('button');
      submitButton.textContent = 'Submit';
      submitButton.type = 'button';

    // Fetching inputs and round them to the first decimal if needed
      submitButton.addEventListener('click', function () {
        const inputValues = [];
        for (let i = 0; i < numberOfInputs; i++) {
          const inputElement = document.getElementById(`input${i}`);
          
          if (inputElement) {
            const inputValueStr = inputElement.value;
            let inputValue = parseFloat(inputValueStr);

            if (inputValueStr.includes('.')) {
                const decimalPart = inputValueStr.split('.')[1];
                if (decimalPart.length > 1) {
                    inputValue = Math.round(inputValue * 10) / 10;
                }
            }
            inputValues.push(inputValue);
          }else{
            setAlert("Please fill in the "+i+". input first.")
          }
        }
        callback(inputValues);
        paramsInputContainer.innerHTML = '';
      });
      

      paramsInputContainer.appendChild(submitButton);
    }

    function handleChooseParamsResponse(data){
      setParamSelection(data.params.params, (selectedParams) => {
        data.payload.payload["params"] = selectedParams
        sendRequestToLocalServer(data.payload.action_list_url, data.payload.payload, data.payload.action);
      });
    }
    
    // List the params received from Django server as options and handle the request sending to the local server.
    function setParamSelection(choose_sets, callback) {
      console.log("Choose sets: "+choose_sets)

      const paramsContainer = document.getElementById('paramsContainer');
      const confirmButton = document.getElementById('paramsConfirmButton');
      const selectElements = [];

      // Populate the select options
      paramsContainer.innerHTML = '';
      
      choose_sets.forEach((choose_set, index) => {
        const select = document.createElement('select');
        select.id = `chooseSetSelect${index}`;
        select.name = `chooseSetSelect${index}`;

        choose_set.forEach(param => {
            const option = document.createElement('option');
            option.value = JSON.stringify(param);
            option.textContent = JSON.stringify(param);
            select.appendChild(option);
        });

        paramsContainer.appendChild(select);
        selectElements.push(select);
      });

      // Unhide the container
      paramsContainer.style.display = 'block';

      const submitButton = document.createElement('button');
      submitButton.textContent = 'Submit';
      submitButton.type = 'button';

      submitButton.addEventListener('click', function () {
        const selectedParams = [];
          for (let i = 0; i < selectElements.length; i++) {
              const select = selectElements[i];
              if (select) {
                const selectedValue = JSON.parse(select.value);
                selectedParams.push(selectedValue);
              } else {
                  setAlert(`Dropdown ${i + 1} is missing.`);
                  return;
              }
          }
          callback(selectedParams);

          paramsContainer.style.display = 'none';
          paramsContainer.innerHTML = '';
      });

      paramsContainer.appendChild(submitButton);
    }

    // Send request to local server
    function sendRequestToLocalServer(actionListUrl, payload, action) {
      console.log("sendRequestToLocalServer triggered. "+actionListUrl+payload+action)

      fetch('http://localhost:8001/camera_control', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          'action': action,
          'action_list_url': actionListUrl,
          'payload': payload
        })
      })
      .then(response => response.json())
      .then(data => handleLocalServerResponse(data, action, payload))
      .catch((error) => {
        setAlert('Error communicating with local server: '+ error);
      });
    }
    
    // Handle response from local server
    function handleLocalServerResponse(data, action, payload) {
      let response = ''

      if (data.error) {
        response = '❌ Error: \n' + JSON.stringify(data.error, null, 2);
      } else {
        response = '✅ Action "' + payload.method + '" executed successfully.\n'+JSON.stringify(data.result, null, 2);
        const isLiveViewInput = document.getElementById('id_isLiveView');
        const isRecordInput = document.getElementById('id_isRecord');
        const isStillShootingInput = document.getElementById('id_isStillShooting');
        const liveViewContainer = document.getElementById('liveViewContainer');
        const liveViewImage = document.getElementById('liveViewImage');

        // Update form inputs based on successful action and adjust html data.
        if (action == 'startRecMode') {
          isRecordInput.value = 1;
          isStillShootingInput.value = 1;
        } else if (action == 'stopRecMode') {
          isRecordInput.value = 0;
          isStillShootingInput.value = 1;
        } else if (action == 'startLiveview' || action == 'startLiveviewWithSize') {
          liveViewContainer.style.display = 'block';
          liveViewImage.src = 'http://localhost:8001/liveview?' + new Date().getTime();
          isLiveViewInput.value = 1;
        } else if (action == 'stopLiveview' || action == 'stopRecMode') {
          liveViewContainer.style.display = 'none';
          liveViewImage.src = '';
          isLiveViewInput.value = 0;
        }
      }
      setAlert(response)
    }

    function setAlert(alertText ){
      const localServerResponse = document.getElementById('localServerResponse')
      localServerResponse.innerHTML = alertText.replace(/\n/g, '<br>')
      localServerResponse.style.display = "block"
    }

    // Init the listeners when the page loads
    init();
  </script>
</body>
</html>