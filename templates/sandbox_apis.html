<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sandbox Mode</title>
</head>
<body>
  <h1>Select and API</h1>

  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Submit</button>
  </form>

  <!-- Container for params dropbox -->
  <div id="paramsContainer" style="display: none;">
    <label for="paramsSelect">Please select a parameter: </label>
    <select id="paramsSelect"></select>
    <button id="paramsConfirmButton" type="button">Confirm</button>
  </div>

  <div id="response-container"></div>

  <script>
    function sendRequestToLocalServer(actionListUrl, payload, action) {
      // Send API request to the local server running on port 8001
      fetch('http://localhost:8001/camera_control', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          'action': action,
          'action_list_url': actionListUrl,
          'payload': payload
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log("Received responsed from Django: ", data)
        if (data.error) {
            alert('Error: ' + data.error);
          }else if (data.params){
            const { action_list_url, payload: payloadData, action } = data.payload;
            const container = document.getElementById('paramsContainer');
            const paramSelection = document.getElementById('paramsSelect');
            const confirmButton = document.getElementById('paramsConfirmButton');

            // Populate the select options
            data.params.forEach(param => {
              const option = document.createElement('option');
              option.value = param;
              option.textContent = param;
              paramSelection.appendChild(option);
            });
            // Unhide the container
            container.style.display = 'block'; 

            confirmButton.onclick = function() {
              const selectedParam = paramSelection.value;
              payloadData['params'] = [selectedParam];
              sendRequestToLocalServer(
                action_list_url,
                payloadData,
                action
              );

              container.style.display = 'none';
              paramSelection.innerHTML = '';
            };
          }else {
            // Send the response data to the local server (Port 8001) for camera control
            sendRequestToLocalServer(data.payload.action_list_url, data.payload.payload, data.payload.action);
          }
        })
        .catch(error => {
        console.error('Error:', error);
      });
    }
  </script>

  {% if api %}
    <h2>Selected API:</h2>
    <p>Api: {{ api.action }}</p>
    <p>Action list url: {{ api.action_list_url }}</p>
    <p>Json object: {{ api.payload }}</p>

    <script>
      var actionListUrl = "{{ api.action_list_url }}";
      var payload = JSON.parse('{{ api.payload|escapejs }}');
      var action = "{{ api.action }}";

      sendRequestToLocalServer(actionListUrl, payload, action);
    </script>
  {% endif %}
</body>
</html>